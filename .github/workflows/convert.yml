name: TranslateGemma → ONNX INT4 変換

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: スワップ拡張 (16GB)
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "=== メモリ状況 ==="
          free -h

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ライブラリインストール
        run: |
          pip install onnxruntime-genai onnx onnx_ir torch transformers sentencepiece protobuf huggingface_hub safetensors

      - name: HF ログイン
        run: |
          python -c "from huggingface_hub import login; login(token='${{ secrets.HF_TOKEN }}')"

      - name: テキストデコーダ抽出
        run: |
          echo "=== テキスト部分だけ公式モデルから抽出 ==="
          python extract_text_decoder.py ./translategemma-text-only
          echo ""
          echo "=== メモリ状況 ==="
          free -h
          echo "=== ディスク状況 ==="
          df -h /

      - name: model builder パッチ適用
        run: python patch_builder.py

      - name: モデル変換 (INT4)
        run: |
          echo "=== 変換開始（テキストデコーダのみ） ==="
          python -m onnxruntime_genai.models.builder \
            -i ./translategemma-text-only \
            -o ./translategemma-genai \
            -p int4 \
            -e cpu
          echo "=== 変換完了 ==="

      - name: 変換結果確認
        run: |
          echo "=== ファイル一覧 ==="
          ls -lh ./translategemma-genai/
          echo ""
          echo "=== 必須ファイルチェック ==="
          for f in genai_config.json tokenizer.json; do
            if [ -f "./translategemma-genai/$f" ]; then
              echo "✅ $f"
            else
              echo "❌ $f が見つかりません"
              exit 1
            fi
          done

      - name: 抽出元を削除してディスク節約
        run: rm -rf ./translategemma-text-only

      - name: Artifact としてアップロード
        uses: actions/upload-artifact@v4
        with:
          name: translategemma-genai-int4
          path: ./translategemma-genai/
          retention-days: 30
