name: TranslateGemma → ONNX INT4 変換

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      - name: スワップ拡張 (32GB) + メモリ設定
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo 1 | sudo tee /proc/sys/vm/overcommit_memory
          echo "=== メモリ状況 ==="
          free -h
          echo "=== ディスク ==="
          df -h /

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ライブラリインストール
        run: |
          pip install onnxruntime-genai onnx onnx_ir torch transformers sentencepiece protobuf huggingface_hub

      - name: HF ログイン
        run: |
          python -c "from huggingface_hub import login; login(token='${{ secrets.HF_TOKEN }}')"

      - name: model builder パッチ適用
        run: python patch_builder.py

      - name: モデル変換 (INT4)
        run: |
          echo "=== 変換開始 ==="
          python -m onnxruntime_genai.models.builder \
            -m google/translategemma-4b-it \
            -o ./translategemma-genai \
            -p int4 \
            -e cpu
          echo "=== 変換完了 ==="

      - name: 変換結果確認
        run: |
          echo "=== ファイル一覧 ==="
          ls -lh ./translategemma-genai/
          echo ""
          for f in genai_config.json tokenizer.json; do
            if [ -f "./translategemma-genai/$f" ]; then
              echo "✅ $f"
            else
              echo "❌ $f が見つかりません"
              exit 1
            fi
          done

      - name: Artifact としてアップロード
        uses: actions/upload-artifact@v4
        with:
          name: translategemma-genai-int4
          path: ./translategemma-genai/
          retention-days: 30
